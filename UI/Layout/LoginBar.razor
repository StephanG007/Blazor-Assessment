@using System.ComponentModel.DataAnnotations
@using Contracts.Account
@using UI.Services
@inject AuthService AuthService
@inject AuthState AuthState
@implements IDisposable

<div class="login-bar">
    @if (currentUser is null)
    {
        <EditForm EditContext="_editContext" OnValidSubmit="HandleLoginAsync" class="login-form">
            <DataAnnotationsValidator />
            <div class="login-fields">
                <div class="dx-field login-field">
                    <InputText id="login-email"
                               class="dx-texteditor dx-editor-outlined"
                               @bind-Value="loginModel.Email"
                               disabled="@isBusy"
                               placeholder="Email"
                               type="email"
                               autocomplete="username" />
                    <ValidationMessage For="() => loginModel.Email" class="validation" />
                </div>
                <div class="dx-field login-field">
                    <InputText id="login-password"
                               class="dx-texteditor dx-editor-outlined"
                               @bind-Value="loginModel.Password"
                               disabled="@isBusy"
                               type="password"
                               placeholder="Password"
                               autocomplete="current-password" />
                    <ValidationMessage For="() => loginModel.Password" class="validation" />
                </div>
                <button type="submit"
                        class="dx-button dx-button-mode-contained dx-button-type-default login-button"
                        disabled="@isBusy">
                    <span class="dx-button-content">@(isBusy ? "Signing in..." : "Log in")</span>
                </button>
            </div>
            @if (!string.IsNullOrWhiteSpace(errorMessage))
            {
                <div class="dx-invalid-message login-error">@errorMessage</div>
            }
        </EditForm>
    }
    else
    {
        <div class="user-summary dx-card">
            <div class="user-avatar" style="@BuildAvatarStyle(currentUser.ImageUrl)">
                @GetInitial(currentUser.DisplayName)
            </div>
            <div class="user-name">@currentUser.DisplayName</div>
            <button type="button"
                    class="dx-button dx-button-mode-text dx-button-type-default logout-button"
                    @onclick="HandleLogout"
                    disabled="@isBusy">
                <span class="dx-button-content">Log out</span>
            </button>
        </div>
    }
</div>

@code {
    private LoginViewModel loginModel = new();
    private EditContext? _editContext;
    private bool isBusy;
    private string? errorMessage;
    private LoginResponse? currentUser;

    protected override void OnInitialized()
    {
        currentUser = AuthState.CurrentUser;
        AuthState.StateChanged += HandleAuthStateChanged;
        _editContext = new EditContext(loginModel);
    }

    private async Task HandleLoginAsync()
    {
        errorMessage = null;
        isBusy = true;

        try
        {
            var (success, error) = await AuthService.LoginAsync(loginModel.Email, loginModel.Password);

            if (!success)
            {
                errorMessage = error;
            }
            else
            {
                loginModel = new LoginViewModel();
                _editContext = new EditContext(loginModel);
            }
        }
        catch
        {
            errorMessage = "We couldn't reach the server. Please try again.";
        }
        finally
        {
            isBusy = false;
        }
    }

    private void HandleLogout()
    {
        errorMessage = null;
        isBusy = true;
        AuthService.Logout();
        isBusy = false;
    }

    private void HandleAuthStateChanged()
    {
        currentUser = AuthState.CurrentUser;
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        AuthState.StateChanged -= HandleAuthStateChanged;
    }

    private static string GetInitial(string? name)
    {
        if (string.IsNullOrWhiteSpace(name))
        {
            return "?";
        }

        var trimmed = name.Trim();
        return trimmed[..1].ToUpperInvariant();
    }

    private static string BuildAvatarStyle(string? imageUrl)
    {
        if (string.IsNullOrWhiteSpace(imageUrl))
        {
            return string.Empty;
        }

        var sanitized = imageUrl.Replace("'", "\\'");
        return $"background-image: url('{sanitized}');";
    }

    private sealed class LoginViewModel
    {
        [Required]
        [EmailAddress]
        public string Email { get; set; } = string.Empty;

        [Required]
        public string Password { get; set; } = string.Empty;
    }
}
