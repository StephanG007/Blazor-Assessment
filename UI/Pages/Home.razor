@page "/"
@using Contracts.Bookings
@using Contracts.Clinics
@using UI.Pages.Home
@inherits HomePage

<PageTitle>Book an appointment</PageTitle>

<div class="home-wrapper">
    <div class="dx-card home-card">
        <h1 class="page-title">Book an appointment</h1>
        <p class="page-lead">Choose a clinic, pick a date, and reserve a slot in just a few clicks.</p>

        @if (_clinicsLoadError is not null)
        {
            <div class="dx-alert dx-alert-danger">@_clinicsLoadError</div>
        }
        else if (_isLoadingClinics)
        {
            <div class="loading-card">
                <DxLoadIndicator CssClass="loading-indicator" />
                <span class="loading-text">Loading clinics...</span>
            </div>
        }
        else if (!HasClinics)
        {
            <div class="dx-alert dx-alert-warning">No clinics are currently available for booking.</div>
        }
        else
        {
            <EditForm Model="_bookingForm" OnValidSubmit="SubmitAsync" class="booking-form">
                <DataAnnotationsValidator />

                <ClinicSelectionSection Clinics="@_clinicSummary!.Clinics"
                                        SelectedClinicId="SelectedClinicId"
                                        SelectedClinicIdChanged="OnClinicSelected"
                                        IsSubmitting="@_isSubmitting"
                                        SelectedDateShort="@SelectedDateShort"
                                        SelectedClinicStatus="@SelectedClinicStatus" />
                <ValidationMessage For="() => _bookingForm.ClinicId" class="validation" />

                <AvailabilitySection SelectedClinicHeading="@SelectedClinicHeading"
                                     SelectedClinicSubtitle="@SelectedClinicSubtitle"
                                     SelectedDateLong="@SelectedDateLong"
                                     SelectedDate="@SelectedDate"
                                     SelectedDateChanged="OnDateChanged"
                                     IsSubmitting="@_isSubmitting"
                                     IsLoadingAvailability="@_isLoadingAvailability"
                                     AvailabilityError="@_availabilityError"
                                     AvailableSlots="@_availableSlots"
                                     SelectedSlotId="@_bookingForm.AppointmentSlotId"
                                     SelectedSlotChanged="OnSlotSelected" />
                <ValidationMessage For="() => _bookingForm.AppointmentSlotId" class="validation" />

                <PatientDetailsSection BookingForm="@_bookingForm" IsSubmitting="@_isSubmitting" />

                <SubmissionSection SubmissionError="@_submissionError"
                                   IsSubmitting="@_isSubmitting"
                                   HasSelectedSlot="@(_bookingForm.AppointmentSlotId is not null)" />
            </EditForm>

            @if (_confirmation is not null)
            {
                <BookingConfirmation Confirmation="@_confirmation" />
            }
        }
    </div>
</div>
